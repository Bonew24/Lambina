<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lambina – Marcos</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#a5b1c2; --text:#e6edf3; --chip:#1b2430; --link:#7aa7ff; --accent:#ff69b4; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,sans-serif;opacity:0;transition:opacity .35s ease}
    body.ready{opacity:1}
    body.fade-out{opacity:0}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px}
    header{position:sticky;top:0;z-index:50;padding:16px 0 12px;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(11,15,20,.92),rgba(11,15,20,.7),rgba(11,15,20,0))}
    .nav{display:flex;gap:14px;margin-bottom:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:6px;box-shadow:0 6px 18px rgba(0,0,0,.25);overflow:hidden}
    .nav a{color:var(--muted);text-decoration:none;font-size:14px;position:relative;padding:8px 12px;border-radius:10px;border:1px solid transparent;transition:all .2s ease}
    .nav a:hover{color:#fff;background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.1)}
    .nav a::after{display:none}
    .nav a.active{color:#0b0f14;background:linear-gradient(90deg,#ff69b4,#9ad0ff);border-color:transparent;box-shadow:0 4px 12px rgba(255,105,180,.35)}
    h1{margin:4px 0 12px;font-size:22px}
    .controls{display:grid;grid-template-columns:1fr 180px 180px;gap:12px}
    .controls input,.controls select{background:var(--chip);color:var(--text);border:1px solid rgba(255,255,255,.08);outline:none;padding:10px 12px;border-radius:10px;font-size:14px}
    main{padding:18px 0 24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:contain;border-radius:10px;background:#0e141c;padding:8px}
    .title{font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;background:var(--chip);padding:2px 6px;border-radius:8px;color:#cfe1ff}
    .meta{font-size:12px;color:#99a3ad}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{background:var(--chip);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:20px;color:var(--muted);font-size:12px}
  </style>
  <link rel="prefetch" href="./index.html" />
  <link rel="prefetch" href="./catalogo.html" />
  <link rel="prefetch" href="./comandos.html" />
  <link rel="prefetch" href="./rates.html" />
</head>
<body>
  <header>
    <div class="wrap">
      <nav class="nav">
        <a href="./index.html">Inicio</a>
        <a href="./catalogo.html">Catálogo</a>
        <a href="./comandos.html">Comandos</a>
        <a href="./rates.html">Rates</a>
        <a class="active" href="./frames.html">Marcos</a>
      </nav>
      <h1>Marcos disponibles</h1>
      <div class="controls">
        <input id="q" placeholder="Buscar por código o autor…" />
        <select id="autor"><option value="">Todos los autores</option></select>
        <select id="orden">
          <option value="code">Ordenar por código</option>
          <option value="autor">Ordenar por autor</option>
        </select>
      </div>
      <div class="pillbar" id="stats"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid" id="grid"></div>
  </main>

  <script>
    async function load() {
      const res = await fetch('./frames_database.json', {cache:'no-store'});
      if (!res.ok) throw new Error('No se pudo cargar frames_database.json');
      const map = await res.json();
      const frames = Object.entries(map).map(([code, obj]) => ({
        code,
        file: String(obj.file||''),
        filename: String(obj.filename||''),
        author_id: obj.author_id ? String(obj.author_id) : ''
      }));

      const grid = document.getElementById('grid');
      const stats = document.getElementById('stats');
      const q = document.getElementById('q');
      const autorSel = document.getElementById('autor');
      const ordenSel = document.getElementById('orden');

      // Normaliza ruta a carpeta Frames relativa a este sitio
      frames.forEach(f => {
        const base = f.file.split('/').pop().split('\\').pop();
        f.webPath = `./Frames/${base}`;
      });

      const autores = [...new Set(frames.map(f => f.author_id).filter(Boolean))].sort();
      autorSel.innerHTML = '<option value="">Todos los autores</option>' + autores.map(a=>`<option value="${a}">${a}</option>`).join('');

      function statChips(list) {
        const total = list.length;
        const porAutor = Object.entries(list.reduce((a,c)=>((a[c.author_id]=(a[c.author_id]||0)+1),a),{}))
          .sort((a,b)=>b[1]-a[1]).slice(0,10).map(([s,n])=>`<span class="pill">${s||'—'}: ${n}</span>`).join('');
        return `<span class="pill">Total: ${total}</span>${porAutor}`;
      }

      function render(list) {
        stats.innerHTML = statChips(list);
        grid.innerHTML = list.map(f => `
          <div class="card">
            <img class="thumb" loading="lazy" src="${f.webPath}" alt="${f.code}" onerror="this.style.display='none'" />
            <div class="title">
              <span>${f.filename}</span>
            </div>
            <div class="meta">Autor: ${f.author_id || '—'}</div>
            <div class="meta">Código: <span class="code">${f.code}</span></div>
          </div>
        `).join('');
      }

      function applyFilters(){
        const term = q.value.trim().toLowerCase();
        const autor = autorSel.value;
        let list = frames.filter(f =>
          (!term || f.code.toLowerCase().includes(term) || f.filename.toLowerCase().includes(term) || (f.author_id||'').includes(term)) &&
          (!autor || f.author_id === autor)
        );

        const ord = ordenSel.value;
        if (ord === 'autor') list.sort((a,b)=> (a.author_id||'').localeCompare(b.author_id||'') || a.code.localeCompare(b.code));
        else list.sort((a,b)=> a.code.localeCompare(b.code));

        render(list);
      }

      q.addEventListener('input', applyFilters);
      autorSel.addEventListener('change', applyFilters);
      ordenSel.addEventListener('change', applyFilters);

      applyFilters();
    }

    load().catch(err => {
      document.getElementById('grid').innerHTML = `<div style="color:#f87171">Error cargando: ${err}</div>`;
    });

    window.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('ready');
      const links = document.querySelectorAll('.nav a[href]');
      links?.forEach(a => {
        a.addEventListener('mouseenter', () => {
          const href = a.getAttribute('href');
          if (!href || href.startsWith('http') || href.startsWith('#')) return;
          fetch(href).catch(()=>{});
        });
        a.addEventListener('click', (e) => {
          const href = a.getAttribute('href');
          if (!href || href.startsWith('http') || href.startsWith('#')) return;
          e.preventDefault();
          document.body.classList.add('fade-out');
          setTimeout(() => location.href = href, 120);
        });
      });
    });
  </script>
</body>
</html>
